// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  NonAdminYee
  AdminYee
  Yer
}

enum InventoryCategory {
  RawMaterial
  WIP
  FinishedGoods
  Waste
}

enum PaymentStatus {
  Pending
  Paid
  Overdue
}

enum AttendanceStatus {
  Present
  Absent
  Leave
}

enum WorkReportType {
  Attendance
  Inventory
}

model User {
  id            String    @id @default(uuid())
  yNumber       String    @unique @db.VarChar(6)
  fullName      String    @db.VarChar(255)
  email         String    @unique
  phone         String    @unique
  passwordHash  String    @map("password_hash")
  role          Role      @default(NonAdminYee)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  createdWarehouses    Warehouse[]            @relation("WarehouseCreator")
  warehouseAssignments WarehouseAssignment[]
  inventoryUpdates     Inventory[]            @relation("InventoryUpdater")
  payrollRecords       Payroll[]
  payrollApprovals     Payroll[]              @relation("PayrollApprover")
  attendanceRecords    Attendance[]
  attendanceRecorded   Attendance[]           @relation("AttendanceRecorder")
  workReports          WorkReport[]
  otps                 OTP[]
  auditLogs            AuditLog[]
  assignedYees         WarehouseAssignment[]  @relation("AssignmentCreator")

  @@map("users")
}

model Warehouse {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(255)
  location    String    @db.VarChar(255)
  description String?   @db.Text
  createdBy   String    @map("created_by")
  isDisabled  Boolean   @default(false) @map("is_disabled")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  creator           User                 @relation("WarehouseCreator", fields: [createdBy], references: [id])
  assignments       WarehouseAssignment[]
  inventory         Inventory[]
  payroll           Payroll[]
  attendance        Attendance[]
  workReports       WorkReport[]
  auditLogs         AuditLog[]

  @@map("warehouses")
}

model WarehouseAssignment {
  id          String   @id @default(uuid())
  warehouseId String   @map("warehouse_id")
  userId      String   @map("user_id")
  isAdmin     Boolean  @default(false) @map("is_admin")
  assignedBy  String   @map("assigned_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  assigner  User      @relation("AssignmentCreator", fields: [assignedBy], references: [id])

  @@unique([warehouseId, userId])
  @@map("warehouse_assignments")
}

model Inventory {
  id          String            @id @default(uuid())
  warehouseId String            @map("warehouse_id")
  category    InventoryCategory
  itemName    String            @map("item_name") @db.VarChar(255)
  quantity    Decimal           @db.Decimal(10, 2)
  unit        String            @db.VarChar(50)
  updatedBy   String            @map("updated_by")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  updater   User      @relation("InventoryUpdater", fields: [updatedBy], references: [id])

  @@map("inventory")
}

model Payroll {
  id            String        @id @default(uuid())
  warehouseId   String        @map("warehouse_id")
  userId        String        @map("user_id")
  salaryAmount  Decimal       @map("salary_amount") @db.Decimal(10, 2)
  paymentStatus PaymentStatus @default(Pending) @map("payment_status")
  approvedBy    String?       @map("approved_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver  User?     @relation("PayrollApprover", fields: [approvedBy], references: [id])

  @@map("payroll")
}

model Attendance {
  id          String          @id @default(uuid())
  warehouseId String          @map("warehouse_id")
  userId      String          @map("user_id")
  date        DateTime        @db.Date
  hoursWorked Decimal         @default(0) @map("hours_worked") @db.Decimal(5, 2)
  status      AttendanceStatus
  recordedBy  String          @map("recorded_by")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  recorder  User      @relation("AttendanceRecorder", fields: [recordedBy], references: [id])

  @@unique([warehouseId, userId, date])
  @@map("attendance")
}

model WorkReport {
  id          String          @id @default(uuid())
  warehouseId String          @map("warehouse_id")
  userId      String          @map("user_id")
  type        WorkReportType
  description String          @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("work_reports")
}

model OTP {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  otpCode   String   @map("otp_code") @db.VarChar(10)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otps")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  warehouseId String?  @map("warehouse_id")
  actionType  String   @map("action_type") @db.VarChar(255)
  description String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouse Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

